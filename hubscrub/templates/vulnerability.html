{% extends "layout.html" %}

{% block body %}

<div id="alert-class" class="alert alert-danger" role="alert">
  <div id="alert">this patchset matched the string '<strong><div id="fingerprint"></div></strong>', please review below.</div>
</div>

<div class="panel panel-info">
    <div class="panel-heading">
        <h3 id="panel-title" class="panel-title"></h3>
    </div>
    <div id="panel-body" class="panel-body"></div>
</div>

<a id="github-link" href="">
    <button type="button" class="btn btn-info" style="float: left; margin-right: 10px;">view on github</button>
</a>

<a href="#" title="approved" data-toggle="popover" data-trigger="focus" data-placement="right" data-content="approved!">
    <button id="approve" type="submit" id="submit" class="btn btn-success">approve</button>
</a>

<br /><br />

<script type="text/javascript">
    function mark_approved() {
        $('#alert-class').removeClass('alert-danger').addClass('alert-success')
        $('#alert').text('approved!')
    }

    $.getJSON("/api/vulnerability/{{ vulnerability_id }}", function(data) {
		$('#fingerprint').replaceWith(data['fingerprint']);
		$('#panel-title').replaceWith(data['filename']);
		$('#panel-body').replaceWith("<pre><code>" + data['patchset'] + "</code></pre>");
        $("#github-link").attr("href", data['link'])

        if (data['approved']) { mark_approved(); }

        if (data['fingerprint_regex']) {
            fingerprint_regex = "/" + data['fingerprint_regex'] + "/i";

            var flags = fingerprint_regex.replace(/.*\/([gimy]*)$/, '$1');
            var pattern = fingerprint_regex.replace(new RegExp('^/(.*?)/' + flags + '$'), '$1');
            var regex = new RegExp(pattern, flags);

            $("code").markRegExp(regex);
        }
    });

    $("#approve").click(function() {
        $.post("/api/vulnerability/{{ vulnerability_id }}", '', function(data)  {
            if (data['ok']) {
                mark_approved();

                window.setTimeout(function(){ window.location.href = "/"; }, 1000);
            }
        }, 'json');
    });
</script>

{% endblock %}
